name: Databricks Notebooks Deployment

on:
  workflow_dispatch:
  # push:
  #   branches: [main, dev, qa]
  #   paths:
  #     - 'AMALDAB/**'
  #     - '.github/workflows/**'

jobs:
  run-prerequisites:
    runs-on: windows-latest
    outputs:
      env_name: ${{ steps.set-env.outputs.env_name }}
    steps:
      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.8'

      - name: Install Python dependencies
        shell: pwsh
        run: |
          python -m pip install --upgrade pip
          pip install requests PyYAML
          # ‚úÖ No databricks-cli ‚Äî not needed

      - name: Install Databricks CLI (Modern Go-based)
        uses: databricks/setup-cli@v1
        with:
          version: '0.276.0'  # ‚úÖ Modern CLI ‚Äî confirmed Go binary

      - name: Verify CLI version (debug safeguard)
        run: |
          $version = databricks --version 2>&1
          Write-Host "Databricks CLI version: $version"
          if ($version -notmatch "v0\.276\.0") {
            Write-Error "‚ùå Unexpected CLI version. Expected v0.276.0 (modern)."
            exit 1
          }

      - name: Create AMALDAB directory structure
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path "AMALDAB/resources/SharedObjects"
          Write-Host "‚úÖ Directory structure created"

      - name: Determine target environment
        id: set-env
        shell: pwsh
        run: |
          $branch = "${{ github.ref }}"
          $envName = switch ($branch) {
            "refs/heads/main" { "PROD" }
            "refs/heads/qa"   { "QA" }
            "refs/heads/dev"  { "DEV" }
            default           { "DEV" }
          }
          echo "ENV_NAME=$envName" | Out-File -FilePath $env:GITHUB_ENV -Append
          echo "env_name=$envName" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          Write-Host "::notice::üéØ Target environment: $envName"

      - name: Inject Databricks credentials (modern CLI: env vars only)
        # ‚úÖ No config files. No `databrickscfg`. No `auth login`.
        # ‚úÖ Service Principal auth via env vars ‚Äî secure & CI-friendly.
        id: inject-creds
        shell: pwsh
        env:
          HOST: ${{ vars[format('{0}_DATABRICKS_HOST', env.ENV_NAME)] }}
          CLIENT_ID: ${{ vars[format('{0}_DATABRICKS_CLIENT_ID', env.ENV_NAME)] }}
          CLIENT_SECRET: ${{ secrets[format('{0}_DATABRICKS_CLIENT_SECRET', env.ENV_NAME)] }}
        run: |
          if (-not $env:HOST -or -not $env:CLIENT_ID -or -not $env:CLIENT_SECRET) {
            Write-Error "‚ùå Missing Databricks credentials for $env:ENV_NAME"
            Write-Host "Expected vars/secrets: ${env:ENV_NAME}_DATABRICKS_*"
            exit 1
          }
          Write-Host "‚úÖ Credentials set for $env:ENV_NAME"
          Write-Host "HOST = $env:HOST"
          # Mask secret in logs
          Write-Host "::add-mask::$env:CLIENT_SECRET"

      - name: Run prerequisites script (with explicit host/token if needed)
        shell: pwsh
        env:
          DATABRICKS_HOST: ${{ vars[format('{0}_DATABRICKS_HOST', env.ENV_NAME)] }}
          DATABRICKS_CLIENT_ID: ${{ vars[format('{0}_DATABRICKS_CLIENT_ID', env.ENV_NAME)] }}
          DATABRICKS_CLIENT_SECRET: ${{ secrets[format('{0}_DATABRICKS_CLIENT_SECRET', env.ENV_NAME)] }}
          # Only if your script uses token auth (e.g., for workspace export)
          DATABRICKS_TOKEN: ${{ secrets.DATABRICKS_TOKEN }}
        run: |
          Write-Host "‚ñ∂Ô∏è Running prerequisites.py for $env:ENV_NAME..."
          python .github/workflows/prerequisites.py `
            --DATABRICKS_HOST "$env:DATABRICKS_HOST" `
            --DATABRICKS_TOKEN "$env:DATABRICKS_TOKEN"

          # Validate outputs
          $required = @(
            "AMALDAB/resources/SharedObjects/all_purpose_clusters.yml",
            "AMALDAB/resources/SharedObjects/sql_warehouses.yml"
          )
          foreach ($f in $required) {
            if (-not (Test-Path $f)) {
              Write-Error "‚ùå Required output missing: $f"
              exit 1
            }
            Write-Host "‚úÖ $f generated"
          }

      - name: Commit generated files (if changed)
        shell: pwsh
        run: |
          git add AMALDAB/resources/
          if (git status --porcelain | Select-String -Pattern "AMALDAB/resources/") {
            git commit -m "chore(deploy): auto-generate configs for ${{ env.ENV_NAME }}"
            git push
            Write-Host "‚úÖ Pushed updated configs"
          } else {
            Write-Host "‚û°Ô∏è No changes to commit"
          }

  deploy-notebooks:
    runs-on: windows-latest
    needs: run-prerequisites
    env:
      ENV_NAME: ${{ needs.run-prerequisites.outputs.env_name }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Databricks CLI
        uses: databricks/setup-cli@v1
        with:
          version: '0.276.0'

      - name: Verify CLI version
        run: |
          $v = databricks --version 2>&1
          Write-Host "CLI: $v"
          if ($v -notmatch "v0\.276\.0") { exit 1 }

      - name: Set Databricks credentials (modern env-based auth)
        shell: pwsh
        env:
          DATABRICKS_HOST: ${{ vars[format('{0}_DATABRICKS_HOST', env.ENV_NAME)] }}
          DATABRICKS_CLIENT_ID: ${{ vars[format('{0}_DATABRICKS_CLIENT_ID', env.ENV_NAME)] }}
          DATABRICKS_CLIENT_SECRET: ${{ secrets[format('{0}_DATABRICKS_CLIENT_SECRET', env.ENV_NAME)] }}
        run: |
          if (-not $env:DATABRICKS_HOST) {
            Write-Error "‚ùå DATABRICKS_HOST not set for $env:ENV_NAME"
            exit 1
          }
          Write-Host "‚úÖ Auth via env vars for $env:ENV_NAME"
          Write-Host "Host: $env:DATABRICKS_HOST"

      - name: ‚úÖ Test authentication (modern CLI)
        env:
          DATABRICKS_HOST: ${{ vars[format('{0}_DATABRICKS_HOST', env.ENV_NAME)] }}
          DATABRICKS_CLIENT_ID: ${{ vars[format('{0}_DATABRICKS_CLIENT_ID', env.ENV_NAME)] }}
          DATABRICKS_CLIENT_SECRET: ${{ secrets[format('{0}_DATABRICKS_CLIENT_SECRET', env.ENV_NAME)] }}
        run: |
          Write-Host "üîç Verifying auth..."
          # This will fail fast if credentials/host are invalid
          databricks auth verify
          Write-Host "‚úÖ Authentication successful"

          # Optional: list 1 cluster to confirm API works
          $cluster = databricks clusters list --limit 1 --output JSON | ConvertFrom-Json
          if ($cluster.clusters) {
            Write-Host "‚úÖ Connected. Sample cluster: $($cluster.clusters[0].cluster_name)"
          }

      - name: üöÄ Deploy Databricks bundle
        env:
          DATABRICKS_HOST: ${{ vars[format('{0}_DATABRICKS_HOST', env.ENV_NAME)] }}
          DATABRICKS_CLIENT_ID: ${{ vars[format('{0}_DATABRICKS_CLIENT_ID', env.ENV_NAME)] }}
          DATABRICKS_CLIENT_SECRET: ${{ secrets[format('{0}_DATABRICKS_CLIENT_SECRET', env.ENV_NAME)] }}
        run: |
          cd AMALDAB
          Write-Host "üì¶ Deploying bundle to $env:ENV_NAME..."
          databricks bundle install
          databricks bundle deploy
          Write-Host "‚úÖ Deployment succeeded for $env:ENV_NAME"
