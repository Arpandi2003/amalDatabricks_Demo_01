name: Databricks Notebooks Deployment

on:
  workflow_dispatch:
  push:
    branches:
      - main
      - dev

    paths:
      - amalDatabricks_Demo_01/**
      - resources/**
      - config/**
      - metrics/data_platform/**
      - .github/workflows/**
      - databricks.yml
jobs:
  # New job to run prerequisites Python file
  run-prerequisites:
    runs-on: windows-latest
    outputs:
      prerequisites-completed: ${{ steps.run-python.outputs.success }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.8'

      - name: Install Python dependencies
        shell: pwsh
        run: |
          python -m pip install --upgrade pip
          # Add any required packages for your prerequisites script
          pip install requests
          # Add other dependencies your prerequisites.ipynb needs


      - name: Run prerequisites Python script
        id: run-python
        shell: pwsh
        env:
          DATABRICKS_HOST: ${{ vars.QA_DATABRICKS_HOST }}
          DATABRICKS_TOKEN: ${{ secrets.DATABRICKS_TOKEN }}
        run: |
          try {
            # Run the prerequisites script
            python prerequisites.py
            # Or if you're running the notebook directly:
            # python -m notebook AMALDAB/config/prerequisites.ipynb
            
            echo "success=true" >> $env:GITHUB_OUTPUT
            Write-Host "✅ Prerequisites completed successfully"
          } catch {
            echo "success=false" >> $env:GITHUB_OUTPUT
            Write-Error "❌ Prerequisites failed"
            exit 1
          }
  deploy-notebooks:
    runs-on: windows-latest
    steps:
      # Step 1: Checkout the repository
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Step 2: Install Databricks CLI
      - name: Install Databricks CLI
        shell: pwsh
        run: |
          Set-ExecutionPolicy Bypass -Scope Process -Force
          [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072
          iex ((New-Object System.Net.WebClient).DownloadString('https://community.chocolatey.org/install.ps1'))
          choco install databricks-cli -y

      # Step 3: Authenticate Databricks Workspace
      - name: Authenticate Databricks Workspace
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path $env:USERPROFILE\.databricks
          @"
          [PROD]
          host = ${{ vars.PROD_DATABRICKS_HOST }}
          client_id = ${{ vars.DATABRICKS_CLIENT_ID }}
          client_secret = ${{ secrets.DATABRICKS_CLIENT_SECRET }}
          [QA]
          host = ${{ vars.QA_DATABRICKS_HOST }}
          client_id = ${{ vars.DATABRICKS_CLIENT_ID }}
          client_secret = ${{ secrets.DATABRICKS_CLIENT_SECRET }}
          "@ | Out-File -FilePath "$env:USERPROFILE\.databrickscfg" -Encoding utf8
          icacls "$env:USERPROFILE\.databrickscfg" /inheritance:r /grant:r "$env:USERNAME:F"
          
          Write-Host "Testing Databricks authentication..."
          databricks auth profiles

      # Step 4: Deploy Databricks bundle
      - name: Deploy Databricks bundle
        shell: pwsh
        env:
          DATABRICKS_CONFIG_PROFILE: QA
        run: |
          cd AMALDAB
      
          echo "Current directory: $(Get-Location)"
          echo "Files in current directory:"
          Get-ChildItem
      
          # Ensure we're using the correct Databricks CLI (new v0.200+)
          databricks --version
      
          # Install bundle dependencies (e.g., wheels, libraries)
          databricks bundle install
      
          # Validate the bundle configuration (catches null refs, missing fields, etc.)
          # databricks bundle validate --target dev
      
          # Run tests if needed (optional; remove if not part of your workflow)
          databricks bundle test --target dev
      
          # Deploy to dev environment
          databricks bundle deploy --target dev
      
          echo "✅ Deployment completed successfully!"
