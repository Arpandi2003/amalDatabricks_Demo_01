name: Databricks Notebooks Deployment

on:
  workflow_dispatch:
  push:
    # branches:
    #   - main
    #   - dev
    # paths:
    #   - amalDatabricks_Demo_01/**
    #   - resources/**
    #   - config/**
    #   - metrics/data_platform/**
    #   - .github/workflows/**
    #   - databricks.yml

jobs:
  # Prerequisites job - must complete first
  run-prerequisites:
    runs-on: windows-latest
    outputs:
      status: ${{ steps.prerequisites.outcome }}
    steps:
      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GIT_TOKEN}} #has this since using an external bot for commit

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.8'

      - name: Install Python dependencies
        shell: pwsh
        run: |
          python -m pip install --upgrade pip
          pip install requests databricks-cli PyYAML

      - name: Create AMALDAB directory structure
        shell: pwsh
        run: |
          echo "Creating directory structure..."
          New-Item -ItemType Directory -Force -Path "AMALDAB/resources/SharedObjects"
          echo "âœ… Directory structure created"
          
      - name: Determine target environment
        id: set-env
        shell: pwsh
        run: |
          $branch = "${{ github.ref }}"
          $envName = switch ($branch) {
            "refs/heads/main" { "PROD" }
            "refs/heads/qa"   { "QA" }
            "refs/heads/dev"  { "DEV" }
            default           { "DEV" }
          }
          
          echo "ENV_NAME=$envName" | Out-File -FilePath $env:GITHUB_ENV -Append
          echo "env_name=$envName" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          Write-Host "::notice::ðŸŽ¯ Target environment: $envName"

      - name: Run prerequisites Python script
        id: prerequisites
        shell: pwsh
        env:
          DATABRICKS_HOST: ${{ vars[format('{0}_DATABRICKS_HOST', env.ENV_NAME)] }}
          DATABRICKS_TOKEN: ${{ secrets[format('{0}_DATABRICKS_TOKEN', env.ENV_NAME)] }}
          # Optional: client_id/secret if needed by script
          # DATABRICKS_CLIENT_ID: ${{ vars[format('{0}_DATABRICKS_CLIENT_ID', env.ENV_NAME)] }}
          # DATABRICKS_CLIENT_SECRET: ${{ secrets[format('{0}_DATABRICKS_CLIENT_SECRET', env.ENV_NAME)] }}
        run: |
          Write-Host "DATABRICKS_HOST: $env:DATABRICKS_HOST"
          Write-Host "DATABRICKS_TOKEN length: $($env:DATABRICKS_TOKEN.Length)"
          
          # python .github/workflows/prerequisites.py `
          #   --DATABRICKS_HOST "$env:DATABRICKS_HOST" `
          #   --DATABRICKS_TOKEN "$env:DATABRICKS_TOKEN"
          
          # Verify outputs
          $clusterFile = "AMALDAB/resources/SharedObjects/all_purpose_clusters.yml"
          $warehouseFile = "AMALDAB/resources/SharedObjects/sql_warehouses.yml"
          
          if (Test-Path $clusterFile) {
            Write-Host "âœ… $clusterFile created"
            Get-Content $clusterFile | Select-Object -First 5
          } else {
            Write-Error "âŒ $clusterFile not found"
            exit 1
          }
          
          if (Test-Path $warehouseFile) {
            Write-Host "âœ… $warehouseFile created"
            Get-Content $warehouseFile | Select-Object -First 5
          } else {
            Write-Error "âŒ $warehouseFile not found"
            exit 1
          }
          
          Write-Host "âœ… Prerequisites completed successfully"
          
      - name: Commit generated files to Git
        shell: pwsh
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add AMALDAB/resources/
          if (-not (git diff --cached --quiet)) {
              git commit -m "chore: auto-generate Databricks cluster & warehouse configs"
              git push
              echo "âœ… Changes committed and pushed to repo."
          } else {
              echo "âž¡ï¸ No changes detected; nothing to commit."
          }    
  # Deployment job - waits for prerequisites to complete
  deploy-notebooks:
    runs-on: windows-latest
    needs: run-prerequisites  # This ensures it waits for prerequisites
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Databricks CLI
        shell: pwsh
        run: |
          Set-ExecutionPolicy Bypass -Scope Process -Force
          [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072
          iex ((New-Object System.Net.WebClient).DownloadString('https://community.chocolatey.org/install.ps1'))
          choco install databricks-cli -y

      - name: Determine target environment (again for this job)
        id: set-env
        shell: pwsh
        run: |
          $branch = "${{ github.ref }}"
          $envName = switch ($branch) {
            "refs/heads/main" { "PROD" }
            "refs/heads/qa"   { "QA" }
            "refs/heads/dev"  { "DEV" }
            default           { "DEV" }
          }
          echo "ENV_NAME=$envName" | Out-File -FilePath $env:GITHUB_ENV -Append
          echo "env_name=$envName" >> $env:GITHUB_OUTPUT
          Write-Host "::notice::ðŸŽ¯ Target environment: $envName"

      - name: Authenticate Databricks Workspace
        shell: pwsh
        env:
          DATABRICKS_HOST: ${{ vars[format('{0}_DATABRICKS_HOST', steps.set-env.outputs.env_name)] }}
          DATABRICKS_TOKEN: ${{ secrets[format('{0}_DATABRICKS_TOKEN', steps.set-env.outputs.env_name)] }}
          DATABRICKS_CLIENT_ID: ${{ vars[format('{0}_DATABRICKS_CLIENT_ID', steps.set-env.outputs.env_name)] }}
          DATABRICKS_CLIENT_SECRET: ${{ secrets[format('{0}_DATABRICKS_CLIENT_SECRET', steps.set-env.outputs.env_name)] }}
          
        run: |
          # Ensure config directory
          $cfgPath = "$env:USERPROFILE\.databrickscfg"
          $profileName = $env:ENV_NAME
          
          @"
          [$profileName]
          host = $env:DATABRICKS_HOST
          token = $env:DATABRICKS_TOKEN
          client_id = $env:DATABRICKS_CLIENT_ID
          client_secret = $env:DATABRICKS_CLIENT_SECRET
          "@ | Out-File -FilePath "$env:USERPROFILE\.databrickscfg" -Encoding utf8
          icacls "$env:USERPROFILE\.databrickscfg" /inheritance:r /grant:r "$env:USERNAME`:F"
          
          Write-Host "Testing Databricks authentication for profile: $profileName"
          databricks --profile $profileName workspace list --page-size 1
          databricks auth profiles

      - name: Deploy Databricks bundle
        shell: pwsh
        working-directory: ./AMALDAB
        env:
          DATABRICKS_CONFIG_PROFILE: ${{ env.ENV_NAME }}  # âœ… Now set via github-env
        run: |
          Write-Host "Deploying bundle to target: $env:ENV_NAME"
          Write-Host "Current directory: $(Get-Location)"
          Get-ChildItem | Out-Host

          # Verify CLI
          $cliPath = (Get-Command databricks -ErrorAction SilentlyContinue)?.Source
          if (-not $cliPath) {
            Write-Error "Databricks CLI not found in PATH"
            exit 1
          }
          & $cliPath --version

          # Install & deploy
          & $cliPath bundle install
          & $cliPath bundle deploy --target $env:ENV_NAME

          Write-Host "âœ… Deployment completed successfully!"
  
  # Optional: Add a validation step
  validate-deployment:
    runs-on: windows-latest
    needs: deploy-notebooks
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate deployment
        shell: pwsh
        run: |
          echo "âœ… All deployment steps completed successfully!"
          echo "Prerequisites status: ${{ needs.run-prerequisites.outputs.status }}"
