name: Databricks Notebooks Deployment

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment to deploy'
        required: true
        type: choice
        options:
          - DEV
          - QA
          - PROD
        default: 'DEV'
  # push:
    # branches:
    #   - main
    #   - dev
    # paths:
    #   - amalDatabricks_Demo_01/**
    #   - resources/**
    #   - config/**
    #   - metrics/data_platform/**
    #   - .github/workflows/**
    #   - databricks.yml

jobs:
  UniTesting:
    runs-on: windows-latest
    defaults:
      run:
        shell: pwsh
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install PowerShell YAML module
        run: |
          $ProgressPreference = 'SilentlyContinue'
          Install-Module powershell-yaml -Force -Scope CurrentUser -AllowClobber
          # Verify installation
          Import-Module powershell-yaml -ErrorAction Stop

      - name: Enforce bundle config policies (is_test, cluster names, env leaks)
        run: |
          Write-Host "üîç Running bundle policy validator..."
          
          # üîí Set execution policy for this session only
          Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope Process -Force
          
          # üìç Define full path to script (relative to repo root)
          $scriptPath = ".github/workflows/validate-bundle.ps1"
          
          # üîç Debug: verify script exists
          if (-not (Test-Path $scriptPath)) {
            Write-Error "‚ùå Script NOT found at: $scriptPath"
            Get-ChildItem -Path . -Recurse | Where-Object Name -like "*validate*"
            exit 1
          }
          
          # ‚úÖ Unblock & execute script safely
          Unblock-File -Path $scriptPath -ErrorAction SilentlyContinue
          & $scriptPath -BundleDir "AMALDAB"
          
          Write-Host "‚úÖ Policy check passed."
          
  run-prerequisites:
    runs-on: windows-latest
    needs: UniTesting
    outputs:
      status: ${{ steps.prerequisites.outcome }}
      env_name: ${{ steps.set-env.outputs.env_name }}
    steps:
      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GIT_TOKEN}} #has this since using an external bot for commit

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.8'

      - name: Install Python dependencies
        shell: pwsh
        run: |
          python -m pip install --upgrade pip
          pip install requests databricks-cli PyYAML

      - name: Create AMALDAB directory structure
        shell: pwsh
        run: |
          echo "Creating directory structure..."
          New-Item -ItemType Directory -Force -Path "AMALDAB/resources/SharedObjects"
          echo "‚úÖ Directory structure created"
          
      - name: Determine target environment
        id: set-env
        shell: pwsh
        run: |
          # Check if manual trigger with environment input
          $manualEnv = "${{ github.event.inputs.environment }}"

          if ($manualEnv) {
            $envName = $manualEnv
            Write-Host "üéØ Manual trigger detected: $envName"
          } else {
            # Auto-trigger based on branch
            $branch = "${{ github.ref }}"
            $envName = switch ($branch) {
              "refs/heads/main" { "PROD" }
              "refs/heads/qa"   { "QA" }
              "refs/heads/dev"  { "DEV" }
              default           { "DEV" }
            }
            Write-Host "üéØ Branch-based trigger: $branch ‚Üí $envName"
          }

          echo "ENV_NAME=$envName" | Out-File -FilePath $env:GITHUB_ENV -Append
          echo "env_name=$envName" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          Write-Host "::notice::üéØ Target environment: $envName"

      - name: Run prerequisites Python script
        id: prerequisites
        shell: pwsh
        env:
          DATABRICKS_HOST: ${{ vars[format('{0}_DATABRICKS_HOST', env.ENV_NAME)] }}
          DATABRICKS_TOKEN: ${{ secrets[format('{0}_DATABRICKS_TOKEN', env.ENV_NAME)] }}
        run: |
          Write-Host "üîß Running prerequisites script..."
          Write-Host "üìç DATABRICKS_HOST: $env:DATABRICKS_HOST"
          Write-Host "üîë DATABRICKS_TOKEN length: $($env:DATABRICKS_TOKEN.Length)"

          # Run the prerequisites script to generate infrastructure configs
          python .github/workflows/prerequisites.py `
            --DATABRICKS_HOST "$env:DATABRICKS_HOST" `
            --DATABRICKS_TOKEN "$env:DATABRICKS_TOKEN"

          if ($LASTEXITCODE -ne 0) {
            Write-Error "‚ùå Prerequisites script failed with exit code $LASTEXITCODE"
            exit $LASTEXITCODE
          }

          # Verify outputs were created
          $clusterFile = "AMALDAB/resources/SharedObjects/all_purpose_clusters.yml"
          $warehouseFile = "AMALDAB/resources/SharedObjects/sql_warehouses.yml"

          if (Test-Path $clusterFile) {
            Write-Host "‚úÖ $clusterFile created"
            Get-Content $clusterFile | Select-Object -First 5
          } else {
            Write-Warning "‚ö†Ô∏è $clusterFile not found (may not have any clusters)"
          }

          if (Test-Path $warehouseFile) {
            Write-Host "‚úÖ $warehouseFile created"
            Get-Content $warehouseFile | Select-Object -First 5
          } else {
            Write-Warning "‚ö†Ô∏è $warehouseFile not found (may not have any warehouses)"
          }

          Write-Host "‚úÖ Prerequisites completed successfully"
          
      - name: Upload generated configs as artifacts
        uses: actions/upload-artifact@v4
        with:
          name: databricks-configs-${{ env.ENV_NAME }}
          path: |
            AMALDAB/resources/SharedObjects/*.yml
            AMALDAB/resources/uc_ddl/*.sql
          retention-days: 30
          if-no-files-found: warn

  # Deployment job - waits for prerequisites to complete
  deploy-notebooks:
    runs-on: windows-latest
    needs: run-prerequisites
    environment: ${{ needs.run-prerequisites.outputs.env_name == 'PROD' && 'production' || needs.run-prerequisites.outputs.env_name }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set environment from previous job
        shell: pwsh
        run: |
          $envName = "${{ needs.run-prerequisites.outputs.env_name }}"
          echo "ENV_NAME=$envName" | Out-File -FilePath $env:GITHUB_ENV -Append
          Write-Host "::notice::üéØ Deploying to environment: $envName"

      - name: Download generated configs
        uses: actions/download-artifact@v4
        with:
          name: databricks-configs-${{ env.ENV_NAME }}
          path: AMALDAB/resources/

      - name: Install Databricks CLI
        shell: pwsh
        run: |
          Write-Host "üì¶ Installing Databricks CLI..."
          curl -fsSL https://raw.githubusercontent.com/databricks/setup-cli/main/install.ps1 | pwsh
          databricks --version
          Write-Host "‚úÖ Databricks CLI installed successfully"

      - name: Authenticate Databricks Workspace
        shell: pwsh
        env:
          DATABRICKS_HOST: ${{ vars[format('{0}_DATABRICKS_HOST', env.ENV_NAME)] }}
          DATABRICKS_TOKEN: ${{ secrets[format('{0}_DATABRICKS_TOKEN', env.ENV_NAME)] }}
          DATABRICKS_CLIENT_ID: ${{ vars[format('{0}_DATABRICKS_CLIENT_ID', env.ENV_NAME)] }}
          DATABRICKS_CLIENT_SECRET: ${{ secrets[format('{0}_DATABRICKS_CLIENT_SECRET', env.ENV_NAME)] }}
        run: |
          Write-Host "üîê Configuring Databricks authentication..."
          $cfgPath = "$env:USERPROFILE\.databrickscfg"
          $profileName = $env:ENV_NAME

          # Create config file line by line to avoid extra newlines
          "[$profileName]" | Out-File -FilePath $cfgPath -Encoding utf8
          "host = $env:DATABRICKS_HOST" | Out-File -FilePath $cfgPath -Encoding utf8 -Append
          "client_id = $env:DATABRICKS_CLIENT_ID" | Out-File -FilePath $cfgPath -Encoding utf8 -Append
          "client_secret = $env:DATABRICKS_CLIENT_SECRET" | Out-File -FilePath $cfgPath -Encoding utf8 -Append

          # Secure the config file
          icacls $cfgPath /inheritance:r /grant:r "$env:USERNAME`:F" | Out-Null

          Write-Host "‚úÖ Config file created at: $cfgPath"
          Write-Host "üß™ Testing authentication..."

          # Test authentication using new CLI command
          databricks auth env --profile $profileName

          Write-Host "‚úÖ Authentication successful!"

      - name: Validate Databricks bundle
        shell: pwsh
        working-directory: ./AMALDAB
        env:
          DATABRICKS_CONFIG_PROFILE: ${{ env.ENV_NAME }}
        run: |
          Write-Host "üîç Validating bundle configuration..."
          databricks bundle validate --target $env:ENV_NAME

          if ($LASTEXITCODE -ne 0) {
            Write-Error "‚ùå Bundle validation failed"
            exit $LASTEXITCODE
          }

          Write-Host "‚úÖ Bundle validation passed"

      - name: Deploy Databricks bundle
        shell: pwsh
        working-directory: ./AMALDAB
        env:
          DATABRICKS_CONFIG_PROFILE: ${{ env.ENV_NAME }}
        run: |
          Write-Host "üöÄ Deploying bundle to target: $env:ENV_NAME"
          Write-Host "üìÅ Current directory: $(Get-Location)"
          Write-Host "üìÇ Bundle contents:"
          Get-ChildItem | Out-Host

          # Verify CLI is available
          $cliVersion = databricks --version
          Write-Host "üì¶ Using Databricks CLI: $cliVersion"

          # Install bundle dependencies
          Write-Host "üì• Installing bundle..."
          databricks bundle install

          if ($LASTEXITCODE -ne 0) {
            Write-Error "‚ùå Bundle install failed"
            exit $LASTEXITCODE
          }

          # Deploy bundle
          Write-Host "üöÄ Deploying bundle..."
          databricks bundle deploy --target $env:ENV_NAME

          if ($LASTEXITCODE -ne 0) {
            Write-Error "‚ùå Bundle deployment failed"
            exit $LASTEXITCODE
          }

          Write-Host "‚úÖ Deployment completed successfully!"

  # Post-deployment summary
  deployment-summary:
    runs-on: windows-latest
    needs: [run-prerequisites, deploy-notebooks]
    if: always()
    steps:
      - name: Deployment Summary
        shell: pwsh
        run: |
          Write-Host "=" * 70
          Write-Host "üìä DEPLOYMENT SUMMARY"
          Write-Host "=" * 70
          Write-Host "üéØ Environment: ${{ needs.run-prerequisites.outputs.env_name }}"
          Write-Host "üìã Prerequisites: ${{ needs.run-prerequisites.outputs.status }}"
          Write-Host "üöÄ Deployment: ${{ needs.deploy-notebooks.result }}"
          Write-Host "=" * 70

          if ("${{ needs.deploy-notebooks.result }}" -eq "success") {
            Write-Host "‚úÖ Deployment completed successfully!"
            exit 0
          } else {
            Write-Host "‚ùå Deployment failed or was cancelled"
            exit 1
          }
