name: Databricks Notebooks Deployment

on:
  workflow_dispatch:
  push:
    branches:
      - main
      - dev
    paths:
      - amalDatabricks_Demo_01/**
      - resources/**
      - config/**
      - metrics/data_platform/**
      - .github/workflows/**
      - databricks.yml

jobs:
  # Prerequisites job - must complete first
  run-prerequisites:
    runs-on: windows-latest
    outputs:
      status: ${{ steps.prerequisites.outcome }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.8'

      - name: Install Python dependencies
        shell: pwsh
        run: |
          python -m pip install --upgrade pip
          pip install requests databricks-cli
          pip install PyYAML
          # Add other dependencies your prerequisites script needs

      - name: Run prerequisites Python script
        id: prerequisites
        shell: pwsh
        env:
          DATABRICKS_HOST: ${{ vars.QA_DATABRICKS_HOST }}
          DATABRICKS_TOKEN: ${{ secrets.DATABRICKS_TOKEN }}
          DATABRICKS_CLIENT_ID: ${{ vars.DATABRICKS_CLIENT_ID }}
          DATABRICKS_CLIENT_SECRET: ${{ secrets.DATABRICKS_CLIENT_SECRET }}
        run: |
          echo "Running prerequisites script..."
          
          # Option 1: If you converted to .py file
          python .github/workflows/prerequisites.py
          
          # Option 2: If running notebook directly (uncomment if needed)
          # python -m papermill AMALDAB/config/prerequisites.ipynb output.ipynb
          
          echo "âœ… Prerequisites completed successfully"