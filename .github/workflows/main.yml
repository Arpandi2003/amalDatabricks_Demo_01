name: Databricks Notebooks Deployment

on:
  workflow_dispatch:
  # push:
  #   branches:
  #     - main
  #     - dev
  # paths:
  #   - amalDatabricks_Demo_01/**
  #   - resources/**
  #   - config/**
  #   - DataPlatform/**
  #   - .github/workflows/**
  #   - databricks.yml

jobs:
  UnitTesting:
    runs-on: windows-latest
    defaults:
      run:
        shell: pwsh
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install PowerShell YAML module
        run: |
          $ProgressPreference = 'SilentlyContinue'
          Install-Module powershell-yaml -Force -Scope CurrentUser -AllowClobber
          Import-Module powershell-yaml -ErrorAction Stop

      - name: Enforce bundle config policies
        run: |
          Write-Host "üîç Running bundle policy validator..."
          Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope Process -Force
          $scriptPath = ".github/workflows/validate-bundle.ps1"
          if (-not (Test-Path $scriptPath)) {
            Write-Error "‚ùå Script NOT found at: $scriptPath"
            exit 1
          }
          Unblock-File -Path $scriptPath -ErrorAction SilentlyContinue
          & $scriptPath -BundleDir "AMALDAB"
          Write-Host "‚úÖ Policy check passed."

  deploy-notebooks:
    runs-on: windows-latest
    needs: UnitTesting
    steps:
      # Step 1: Checkout the repository
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Step 2: Install PowerShell YAML module
      - name: Install PowerShell YAML module
        shell: pwsh
        run: |
          Write-Host "üì¶ Installing PowerShell YAML module..."
          $ProgressPreference = 'SilentlyContinue'
          Install-Module powershell-yaml -Force -Scope CurrentUser -AllowClobber
          Import-Module powershell-yaml -ErrorAction Stop
          Write-Host "‚úÖ PowerShell YAML module installed"

      # Step 3: Update NB_Configuration.py with inline regex replacement
      - name: Update NB_Configuration.py
        shell: pwsh
        run: |
          Write-Host "üîß Updating NB_Configuration.py with environment-specific values..."

          # Import YAML module
          Import-Module powershell-yaml -ErrorAction Stop

          # Read databricks.yml
          $bundleYamlPath = "AMALDAB/databricks.yml"
          $yamlContent = Get-Content $bundleYamlPath -Raw
          $config = ConvertFrom-Yaml $yamlContent

          # Target environment (QA - change as needed)
          $targetEnv = "QA"
          $variables = $config.targets.$targetEnv.variables

          # Extract values
          $keyVaultScope = if ($variables.key_vault_scope.default) { $variables.key_vault_scope.default } else { $variables.key_vault_scope }
          $catalogName = if ($variables.catalog_name.default) { $variables.catalog_name.default } else { $variables.catalog_name }
          $loggerDirectory = if ($variables.logger_directory.default) { $variables.logger_directory.default } else { $variables.logger_directory }
          $axiomArchive = if ($variables.axiom_archive.default) { $variables.axiom_archive.default } else { $variables.axiom_archive }
          $axiomInput = if ($variables.axiom_input.default) { $variables.axiom_input.default } else { $variables.axiom_input }
          $axiomVolume = if ($variables.axiom_volume.default) { $variables.axiom_volume.default } else { $variables.axiom_volume }

          # Environment-specific values (notebook-only)
          switch ($targetEnv) {
            'DEV' {
              $employeeFlagPath = '/Volumes/ab_dev_catalog/bronze/unstructured/Employee_Flag/employee_flag.csv'
              $marketingSourceSystem = 'NYHQ_PROD'
            }
            'QA' {
              $employeeFlagPath = '/Volumes/ab_qa_catalog/bronze/unstructured/Employee_Flag/employee_flag.csv'
              $marketingSourceSystem = 'NYHQ_PROD'
            }
            'PROD' {
              $employeeFlagPath = '/Volumes/ab_prod_catalog/bronze/unstructured/Employee_Flag/employee_flag.csv'
              $marketingSourceSystem = 'NYHQ_PROD'
            }
          }

          Write-Host "‚úÖ Extracted variables for $targetEnv environment"

          # Read configuration file
          $configFile = "AMALDAB/DataPlatform/General/NB_Configuration.py"
          $content = Get-Content $configFile -Raw

          # Apply regex replacements
          $content = $content -replace "scope='[^']*'", "scope='$keyVaultScope'"
          $content = $content -replace "catalog='[^']*'", "catalog='$catalogName'"
          $content = $content -replace "logger_directory='[^']*'", "logger_directory='$loggerDirectory'"
          $content = $content -replace "axiom_archive = '[^']*'", "axiom_archive = '$axiomArchive'"
          $content = $content -replace "axiom_input = '[^']*'", "axiom_input = '$axiomInput'"
          $content = $content -replace 'axiom_volume="[^"]*"', "axiom_volume=`"$axiomVolume`""
          $content = $content -replace "employee_flag_path='[^']*'", "employee_flag_path='$employeeFlagPath'"
          $content = $content -replace "marketing_source_system = '[^']*'", "marketing_source_system = '$marketingSourceSystem'"

          # Write back to file
          $content | Set-Content $configFile -NoNewline

          Write-Host "‚úÖ Configuration file updated successfully!"

      # Step 4: Install Databricks CLI
      - name: Install Databricks CLI
        shell: pwsh
        run: |
          Write-Host "üì¶ Installing Databricks CLI..."
          
          $ProgressPreference = 'SilentlyContinue'
          $os = "windows"
          $arch = "amd64"
          
          # Get latest version from GitHub API
          $latestRelease = Invoke-RestMethod -Uri "https://api.github.com/repos/databricks/cli/releases/latest"
          $version = $latestRelease.tag_name.TrimStart('v')
          
          Write-Host "üì• Downloading Databricks CLI version $version..."
          
          # Download URL
          $downloadUrl = "https://github.com/databricks/cli/releases/download/v$version/databricks_cli_${version}_${os}_${arch}.zip"
          $zipPath = "$env:TEMP\databricks-cli.zip"
          $extractPath = "$env:TEMP\databricks-cli"
          $installPath = "$env:USERPROFILE\.databricks\cli"
          
          # Download and extract
          Invoke-WebRequest -Uri $downloadUrl -OutFile $zipPath
          Expand-Archive -Path $zipPath -DestinationPath $extractPath -Force
          
          # Install
          New-Item -ItemType Directory -Force -Path $installPath | Out-Null
          Copy-Item -Path "$extractPath\databricks.exe" -Destination "$installPath\databricks.exe" -Force
          
          # Add to PATH for current session and subsequent steps
          "$installPath" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
          $env:PATH = "$installPath;$env:PATH"
          
          # Verify installation
          & "$installPath\databricks.exe" --version
          Write-Host "‚úÖ Databricks CLI installed successfully"

      # Step 5: Authenticate Databricks Workspace
      - name: Authenticate Databricks Workspace
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path $env:USERPROFILE\.databricks
          @"
          [PROD]
          host = ${{ vars.PROD_DATABRICKS_HOST }}
          client_id = ${{ vars.DATABRICKS_CLIENT_ID }}
          client_secret = ${{ secrets.DATABRICKS_CLIENT_SECRET }}
          [QA]
          host = ${{ vars.QA_DATABRICKS_HOST }}
          client_id = ${{ vars.DATABRICKS_CLIENT_ID }}
          client_secret = ${{ secrets.DATABRICKS_CLIENT_SECRET }}
          "@ | Out-File -FilePath "$env:USERPROFILE\.databrickscfg" -Encoding utf8
          icacls "$env:USERPROFILE\.databrickscfg" /inheritance:r /grant:r "$env:USERNAME:F"
          
          Write-Host "Testing Databricks authentication..."
          databricks auth profiles

      # Step 6: Deploy Databricks bundle
      - name: Deploy Databricks bundle
        shell: pwsh
        env:
          DATABRICKS_CONFIG_PROFILE: QA
        run: |
          cd AMALDAB

          echo "Current directory: $(Get-Location)"
          echo "Files in current directory:"
          Get-ChildItem

          # Validate bundle
          databricks bundle validate -t QA

          # Deploy bundle
          databricks bundle deploy -t QA

          echo "‚úÖ Deployment completed successfully!"

      # Step 7: Sync workspace and remove deleted files
      - name: Sync workspace with deletion
        shell: pwsh
        env:
          DATABRICKS_CONFIG_PROFILE: QA
        run: |
          Write-Host "üîÑ Syncing workspace and removing deleted files..."

          # Set execution policy
          Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope Process -Force

          # Unblock the script
          $scriptPath = ".github/workflows/sync-with-deletion.ps1"
          if (-not (Test-Path $scriptPath)) {
            Write-Warning "‚ö†Ô∏è  Sync script not found at: $scriptPath - skipping sync"
            exit 0
          }

          Unblock-File -Path $scriptPath -ErrorAction SilentlyContinue

          # Run sync script
          try {
            & $scriptPath -SourceDir "AMALDAB" -WorkspacePath "/Workspace/AMAL_QA/QA" -Profile "QA"

            if ($LASTEXITCODE -and $LASTEXITCODE -ne 0) {
              Write-Error "‚ùå Sync with deletion failed with exit code: $LASTEXITCODE"
              exit $LASTEXITCODE
            }

            Write-Host "‚úÖ Workspace sync completed successfully"
          }
          catch {
            Write-Error "‚ùå Sync with deletion failed: $_"
            exit 1
          }

