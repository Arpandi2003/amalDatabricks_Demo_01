name: Databricks Asset Bundle Deployment

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        type: choice
        options:
          - DEV
          - QA
          - PROD
  # Uncomment to enable automatic deployment on push
  # push:
  #   branches: [dev, qa, main]
  #   paths:
  #     - 'AMALDAB/**'
  #     - '.github/workflows/**'

jobs:
  run-prerequisites:
    runs-on: windows-latest
    outputs:
      env_name: ${{ steps.set-env.outputs.env_name }}
    steps:
      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.8'

      - name: Install Python dependencies
        shell: pwsh
        run: |
          python -m pip install --upgrade pip
          pip install requests databricks-cli PyYAML

      - name: Install Databricks CLI
        shell: pwsh
        run: |
          Write-Host "üì¶ Installing Databricks CLI..."
          curl -fsSL https://raw.githubusercontent.com/databricks/setup-cli/main/install.ps1 | pwsh
          databricks --version
          Write-Host "‚úÖ Databricks CLI installed successfully"

      - name: Create AMALDAB directory structure
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path "AMALDAB/resources/SharedObjects"
          Write-Host "‚úÖ Directory structure created"

      - name: Determine environment
        id: set-env
        shell: pwsh
        run: |
          # Use manual input if workflow_dispatch, otherwise determine from branch
          if ("${{ github.event.inputs.environment }}" -ne "") {
            $envName = "${{ github.event.inputs.environment }}"
            Write-Host "::notice::Using manual environment selection: $envName"
          } else {
            $branch = "${{ github.ref }}"
            $envName = switch ($branch) {
              "refs/heads/main" { "PROD" }
              "refs/heads/qa"   { "QA" }
              "refs/heads/dev"  { "DEV" }
              default           { "DEV" }
            }
            Write-Host "::notice::Environment determined from branch: $envName"
          }

          echo "ENV_NAME=$envName" | Out-File -FilePath $env:GITHUB_ENV -Append
          echo "env_name=$envName" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          Write-Host "::notice::üéØ Target environment: $envName"

      - name: Generate Databricks config file
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path $env:USERPROFILE\.databricks
          @"
          [DEV]
          host = "${{ vars.QA_DATABRICKS_HOST }}"
          client_id = "${{ vars.DEV_DATABRICKS_CLIENT_ID }}"
          client_secret = "${{ secrets.DEV_DATABRICKS_CLIENT_SECRET }}"
          
          [QA]
          host = "${{ vars.QA_DATABRICKS_HOST }}"
          client_id = "${{ vars.QA_DATABRICKS_CLIENT_ID }}"
          client_secret = "${{ secrets.QA_DATABRICKS_CLIENT_SECRET }}"
          
          [PROD]
          host = "${{ vars.PROD_DATABRICKS_HOST }}"
          client_id = "${{ vars.PROD_DATABRICKS_CLIENT_ID }}"
          client_secret = "${{ secrets.PROD_DATABRICKS_CLIENT_SECRET }}"
          
          "@ | Out-File -FilePath "$env:USERPROFILE\.databrickscfg" -Encoding utf8
          icacls "$env:USERPROFILE\.databrickscfg" /inheritance:r /grant:r "$env:USERNAME:F"
          databricks auth profiles
          Write-Host "‚úÖ .databrickscfg generated with UAT and PROD profiles"

      - name: Run prerequisites Python script
        shell: pwsh
        env:
          ENV_NAME: ${{ env.ENV_NAME }}
          DATABRICKS_CONFIG_PROFILE: ${{ env.ENV_NAME }}
        run: |
          Write-Host "üîß Running prerequisites.py for $env:ENV_NAME environment..."

          # Resolve host and token based on ENV_NAME
          $databricksHost = switch ($env:ENV_NAME) {
            "PROD" { "${{ vars.PROD_DATABRICKS_HOST }}" }
            "QA"   { "${{ vars.QA_DATABRICKS_HOST }}" }
            "DEV"  { "${{ vars.DEV_DATABRICKS_HOST || vars.QA_DATABRICKS_HOST }}" }
            default { "${{ vars.QA_DATABRICKS_HOST }}" }
          }

          $databricksToken = "${{ secrets.DATABRICKS_TOKEN }}"

          Write-Host "üìç Target Workspace: $databricksHost"

          # Run script with CLI args
          python .github/workflows/prerequisites.py `
            --DATABRICKS_HOST "$databricksHost" `
            --DATABRICKS_TOKEN "$databricksToken"

          # Verify outputs
          $files = @(
            "AMALDAB/resources/SharedObjects/all_purpose_clusters.yml",
            "AMALDAB/resources/SharedObjects/sql_warehouses.yml"
          )
          foreach ($f in $files) {
            if (Test-Path $f) {
              Write-Host "‚úÖ $f generated successfully"
            } else {
              Write-Host "::error::‚ùå Required file missing: $f"
              exit 1
            }
          }
          Write-Host "‚úÖ All prerequisite files generated successfully"

      # Upload generated configs as artifacts instead of committing
      - name: Upload generated configs as artifacts
        uses: actions/upload-artifact@v4
        with:
          name: databricks-configs-${{ env.ENV_NAME }}
          path: |
            AMALDAB/resources/SharedObjects/*.yml
            AMALDAB/resources/uc_ddl/*.sql
          retention-days: 30
          if-no-files-found: warn

      # Optional: Uncomment to commit generated files (NOT RECOMMENDED for production)
      # - name: Commit generated files (if changed)
      #   shell: pwsh
      #   run: |
      #     git add AMALDAB/resources/
      #     $gitStatus = git status --porcelain
      #     if ($gitStatus) {
      #       git commit -m "chore(deploy): auto-generate configs for ${{ env.ENV_NAME }}"
      #       git push
      #       Write-Host "‚úÖ Pushed generated configs"
      #     } else {
      #       Write-Host "‚û°Ô∏è No changes to commit"
      #     }

  deploy-notebooks:
    runs-on: windows-latest
    needs: run-prerequisites
    # Add environment protection for PROD deployments
    environment:
      name: ${{ needs.run-prerequisites.outputs.env_name == 'PROD' && 'production' || needs.run-prerequisites.outputs.env_name }}
    env:
      ENV_NAME: ${{ needs.run-prerequisites.outputs.env_name }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Databricks CLI
        shell: pwsh
        run: |
          Write-Host "üì¶ Installing Databricks CLI..."
          curl -fsSL https://raw.githubusercontent.com/databricks/setup-cli/main/install.ps1 | pwsh
          databricks --version
          Write-Host "‚úÖ Databricks CLI installed successfully"

      - name: Download generated configs
        uses: actions/download-artifact@v4
        with:
          name: databricks-configs-${{ env.ENV_NAME }}
          path: AMALDAB/resources/

      - name: Generate Databricks config for deployment
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path $env:USERPROFILE\.databricks
          @"
          [DEV]
          host = "${{ vars.QA_DATABRICKS_HOST }}"
          client_id = "${{ vars.DEV_DATABRICKS_CLIENT_ID }}"
          client_secret = "${{ secrets.DEV_DATABRICKS_CLIENT_SECRET }}"
          
          [QA]
          host = "${{ vars.QA_DATABRICKS_HOST }}"
          client_id = "${{ vars.QA_DATABRICKS_CLIENT_ID }}"
          client_secret = "${{ secrets.QA_DATABRICKS_CLIENT_SECRET }}"
          
          [PROD]
          host = "${{ vars.PROD_DATABRICKS_HOST }}"
          client_id = "${{ vars.PROD_DATABRICKS_CLIENT_ID }}"
          client_secret = "${{ secrets.PROD_DATABRICKS_CLIENT_SECRET }}"
          
          "@ | Out-File -FilePath "$env:USERPROFILE\.databrickscfg" -Encoding utf8
          icacls "$env:USERPROFILE\.databrickscfg" /inheritance:r /grant:r "$env:USERNAME:F"
          databricks auth profiles
          Write-Host "‚úÖ .databrickscfg generated with UAT and PROD profiles"

      - name: Validate Databricks bundle
        shell: pwsh
        env:
          DATABRICKS_CONFIG_PROFILE: ${{ needs.run-prerequisites.outputs.env_name }}
        run: |
          cd AMALDAB
          Write-Host "üîç Validating bundle for target: $env:DATABRICKS_CONFIG_PROFILE"

          databricks bundle validate --target $env:DATABRICKS_CONFIG_PROFILE

          Write-Host "‚úÖ Bundle validation successful"

      - name: Test authentication
        shell: pwsh
        env:
          DATABRICKS_CONFIG_PROFILE: ${{ needs.run-prerequisites.outputs.env_name }}
        run: |
          Write-Host "üîê Testing authentication for $env:DATABRICKS_CONFIG_PROFILE..."

          # Test authentication by listing workspaces or getting current user
          databricks auth env --profile $env:DATABRICKS_CONFIG_PROFILE

          Write-Host "‚úÖ Authentication successful"

      - name: Deploy Databricks bundle
        shell: pwsh
        env:
          DATABRICKS_CONFIG_PROFILE: ${{ needs.run-prerequisites.outputs.env_name }}
        run: |
          cd AMALDAB
          Write-Host "=" * 70
          Write-Host "üöÄ Deploying to target: $env:DATABRICKS_CONFIG_PROFILE"
          Write-Host "=" * 70

          # Deploy bundle
          databricks bundle deploy --target $env:DATABRICKS_CONFIG_PROFILE

          Write-Host "=" * 70
          Write-Host "‚úÖ Deployment completed successfully for $env:DATABRICKS_CONFIG_PROFILE"
          Write-Host "=" * 70

      - name: Deployment Summary
        if: always()
        shell: pwsh
        env:
          ENV_NAME: ${{ needs.run-prerequisites.outputs.env_name }}
        run: |
          Write-Host ""
          Write-Host "=" * 70
          Write-Host "üìä DEPLOYMENT SUMMARY"
          Write-Host "=" * 70
          Write-Host "üéØ Environment: $env:ENV_NAME"
          Write-Host "üìÖ Timestamp: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')"
          Write-Host "üë§ Triggered by: ${{ github.actor }}"
          Write-Host "üîó Workflow run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          Write-Host "=" * 70
