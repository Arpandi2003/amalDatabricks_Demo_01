name: Databricks Notebooks Deployment

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: false
        type: choice
        options:
          - AUTO
          - DEV
          - UAT
          - PROD
        default: 'AUTO'
  push:
    branches:
      - main
      - dev
      - qa
    paths:
      - AMALDAB/**
      - .github/workflows/**

jobs:
  UnitTesting:
    runs-on: windows-latest
    defaults:
      run:
        shell: pwsh
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install PowerShell YAML module
        run: |
          Write-Host "üì¶ Installing PowerShell YAML module..."
          $ProgressPreference = 'SilentlyContinue'
          Install-Module powershell-yaml -Force -Scope CurrentUser -AllowClobber
          Import-Module powershell-yaml -ErrorAction Stop
          Write-Host "‚úÖ PowerShell YAML module installed"

      - name: Enforce bundle config policies
        run: |
          Write-Host "üîç Running bundle policy validator..."
          Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope Process -Force
          $scriptPath = ".github/workflows/validate-bundle.ps1"
          if (-not (Test-Path $scriptPath)) {
            Write-Error "‚ùå Script NOT found at: $scriptPath"
            exit 1
          }
          Unblock-File -Path $scriptPath -ErrorAction SilentlyContinue
          & $scriptPath -BundleDir "AMALDAB"
          if ($LASTEXITCODE -and $LASTEXITCODE -ne 0) {
            Write-Error "‚ùå Policy validation failed"
            exit $LASTEXITCODE
          }
          Write-Host "‚úÖ Policy check passed"

  deploy-notebooks:
    runs-on: windows-latest
    needs: UnitTesting
    steps:
      # Step 1: Checkout the repository
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Step 2: Determine target environment
      - name: Determine target environment
        id: determine-env
        shell: pwsh
        run: |
          Write-Host "üéØ Determining target environment..."

          # Check if manual environment was specified
          $manualEnv = "${{ github.event.inputs.environment }}"

          if ($manualEnv -and $manualEnv -ne "AUTO") {
            $targetEnv = $manualEnv
            Write-Host "üìå Using manually specified environment: $targetEnv"
          }
          else {
            # Auto-detect based on branch
            $branch = "${{ github.ref }}"
            Write-Host "üîç Detecting environment from branch: $branch"

            if ($branch -eq "refs/heads/main") {
              $targetEnv = "PROD"
            }
            elseif ($branch -eq "refs/heads/qa" -or $branch -eq "refs/heads/uat") {
              $targetEnv = "uat"
            }
            elseif ($branch -eq "refs/heads/dev") {
              $targetEnv = "DEV"
            }
            else {
              # Default to DEV for feature branches
              $targetEnv = "DEV"
              Write-Host "‚ö†Ô∏è  Unknown branch, defaulting to DEV"
            }

            Write-Host "‚úÖ Auto-detected environment: $targetEnv"
          }

          # Set output for subsequent steps
          "environment=$targetEnv" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          Write-Host "üéØ Target Environment: $targetEnv"

      # Step 3: Install PowerShell YAML module
      - name: Install PowerShell YAML module
        shell: pwsh
        run: |
          Write-Host "üì¶ Installing PowerShell YAML module..."
          $ProgressPreference = 'SilentlyContinue'
          Install-Module powershell-yaml -Force -Scope CurrentUser -AllowClobber
          Import-Module powershell-yaml -ErrorAction Stop
          Write-Host "‚úÖ PowerShell YAML module installed"

      # Step 4: Update NB_Configuration.py with dynamic environment-based replacement
      - name: Update NB_Configuration.py
        shell: pwsh
        env:
          TARGET_ENV: ${{ steps.determine-env.outputs.environment }}
        run: |
          Write-Host "üîß Updating NB_Configuration.py with environment-specific values..."
          Write-Host "üéØ Target Environment: $env:TARGET_ENV"

          # Import YAML module
          Import-Module powershell-yaml -ErrorAction Stop

          # Read databricks.yml
          $bundleYamlPath = "AMALDAB/databricks.yml"
          if (-not (Test-Path $bundleYamlPath)) {
            Write-Error "‚ùå databricks.yml not found at: $bundleYamlPath"
            exit 1
          }

          $yamlContent = Get-Content $bundleYamlPath -Raw
          $config = ConvertFrom-Yaml $yamlContent

          # Get target environment variables
          $targetEnv = $env:TARGET_ENV
          if (-not $config.targets.$targetEnv) {
            Write-Error "‚ùå Environment '$targetEnv' not found in databricks.yml"
            exit 1
          }

          $variables = $config.targets.$targetEnv.variables

          # Extract values (handle both direct values and default values)
          $keyVaultScope = if ($variables.key_vault_scope.default) { $variables.key_vault_scope.default } else { $variables.key_vault_scope }
          $catalogName = if ($variables.catalog_name.default) { $variables.catalog_name.default } else { $variables.catalog_name }
          $loggerDirectory = if ($variables.logger_directory.default) { $variables.logger_directory.default } else { $variables.logger_directory }
          $axiomArchive = if ($variables.axiom_archive.default) { $variables.axiom_archive.default } else { $variables.axiom_archive }
          $axiomInput = if ($variables.axiom_input.default) { $variables.axiom_input.default } else { $variables.axiom_input }
          $axiomVolume = if ($variables.axiom_volume.default) { $variables.axiom_volume.default } else { $variables.axiom_volume }

          # Environment-specific values (not in databricks.yml - notebook-only configuration)
          switch ($targetEnv) {
            'DEV' {
              $employeeFlagPath = '/Volumes/ab_dev_catalog/bronze/unstructured/Employee_Flag/employee_flag.csv'
              $marketingSourceSystem = 'NYHQ_PROD'
            }
            'uat' {
              $employeeFlagPath = '/Volumes/ab_uat_catalog/bronze/unstructured/Employee_Flag/employee_flag.csv'
              $marketingSourceSystem = 'NYHQ_PROD'
            }
            'UAT' {
              $employeeFlagPath = '/Volumes/ab_uat_catalog/bronze/unstructured/Employee_Flag/employee_flag.csv'
              $marketingSourceSystem = 'NYHQ_PROD'
            }
            'PROD' {
              $employeeFlagPath = '/Volumes/ab_prod_catalog/bronze/unstructured/Employee_Flag/employee_flag.csv'
              $marketingSourceSystem = 'NYHQ_PROD'
            }
            default {
              Write-Error "‚ùå Unknown environment: $targetEnv"
              exit 1
            }
          }

          Write-Host "‚úÖ Extracted variables for $targetEnv environment:"
          Write-Host "   - Key Vault Scope: $keyVaultScope"
          Write-Host "   - Catalog: $catalogName"
          Write-Host "   - Logger Directory: $loggerDirectory"
          Write-Host "   - Axiom Archive: $axiomArchive"
          Write-Host "   - Axiom Input: $axiomInput"
          Write-Host "   - Axiom Volume: $axiomVolume"
          Write-Host "   - Employee Flag Path: $employeeFlagPath"
          Write-Host "   - Marketing Source System: $marketingSourceSystem"

          # Read configuration file
          $configFile = "AMALDAB/DataPlatform/General/NB_Configuration.py"
          if (-not (Test-Path $configFile)) {
            Write-Error "‚ùå Configuration file not found at: $configFile"
            exit 1
          }

          $content = Get-Content $configFile -Raw

          # Define all regex replacements (matching deploy.yml patterns)
          $replacements = @{
            "scope='[^']*'" = "scope='$keyVaultScope'"
            "catalog='[^']*'" = "catalog='$catalogName'"
            "logger_directory='[^']*'" = "logger_directory='$loggerDirectory'"
            "axiom_archive = '[^']*'" = "axiom_archive = '$axiomArchive'"
            "axiom_input = '[^']*'" = "axiom_input = '$axiomInput'"
            'axiom_volume="[^"]*"' = "axiom_volume=`"$axiomVolume`""
            "employee_flag_path='[^']*'" = "employee_flag_path='$employeeFlagPath'"
            "marketing_source_system = '[^']*'" = "marketing_source_system = '$marketingSourceSystem'"
          }

          # Apply all replacements
          Write-Host ""
          Write-Host "üîÑ Applying configuration replacements..."
          foreach ($pattern in $replacements.Keys) {
            $replacement = $replacements[$pattern]
            if ($content -match $pattern) {
              $content = $content -replace $pattern, $replacement
              Write-Host "   ‚úÖ Replaced: $pattern"
            }
            else {
              Write-Warning "   ‚ö†Ô∏è  Pattern not found: $pattern"
            }
          }

          # Write back to file
          $content | Set-Content $configFile -NoNewline -Encoding UTF8

          Write-Host ""
          Write-Host "‚úÖ Configuration file updated successfully!"
          Write-Host ""
          Write-Host "üìÑ Updated NB_Configuration.py contents:"
          Write-Host "=" * 70
          Get-Content $configFile
          Write-Host "=" * 70

      # Step 5: Set up Python (for BOM removal if needed)
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      # Step 6: Install Databricks CLI
      - name: Install Databricks CLI
        shell: pwsh
        run: |
          Write-Host "üì¶ Installing Databricks CLI..."

          $ProgressPreference = 'SilentlyContinue'
          $os = "windows"
          $arch = "amd64"

          # Get latest version from GitHub API
          try {
            $latestRelease = Invoke-RestMethod -Uri "https://api.github.com/repos/databricks/cli/releases/latest"
            $version = $latestRelease.tag_name.TrimStart('v')
            Write-Host "üì• Downloading Databricks CLI version $version..."
          }
          catch {
            Write-Error "‚ùå Failed to get latest CLI version: $_"
            exit 1
          }

          # Download URL
          $downloadUrl = "https://github.com/databricks/cli/releases/download/v$version/databricks_cli_${version}_${os}_${arch}.zip"
          $zipPath = "$env:TEMP\databricks-cli.zip"
          $extractPath = "$env:TEMP\databricks-cli"
          $installPath = "$env:USERPROFILE\.databricks\cli"

          # Download and extract
          try {
            Invoke-WebRequest -Uri $downloadUrl -OutFile $zipPath
            Expand-Archive -Path $zipPath -DestinationPath $extractPath -Force

            # Install
            New-Item -ItemType Directory -Force -Path $installPath | Out-Null
            Copy-Item -Path "$extractPath\databricks.exe" -Destination "$installPath\databricks.exe" -Force

            # Add to PATH for current session and subsequent steps
            "$installPath" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
            $env:PATH = "$installPath;$env:PATH"

            # Verify installation
            & "$installPath\databricks.exe" --version
            Write-Host "‚úÖ Databricks CLI installed successfully"
          }
          catch {
            Write-Error "‚ùå Failed to install Databricks CLI: $_"
            exit 1
          }

      # Step 7: Authenticate Databricks Workspace (Service Principal Only)
      - name: Authenticate Databricks Workspace
        shell: pwsh
        env:
          TARGET_ENV: ${{ steps.determine-env.outputs.environment }}
        run: |
          Write-Host "üîê Configuring Databricks authentication with Service Principal..."
          Write-Host "üéØ Target Environment: $env:TARGET_ENV"

          # Get environment-specific credentials
          $databricksHost = ""
          $clientId = ""
          $clientSecret = ""

          switch ($env:TARGET_ENV) {
            'DEV' {
              $databricksHost = "${{ vars.DEV_DATABRICKS_HOST }}"
              $clientId = "${{ vars.DEV_DATABRICKS_CLIENT_ID }}"
              $clientSecret = "${{ secrets.DEV_DATABRICKS_CLIENT_SECRET }}"
            }
            { $_ -in 'uat', 'UAT' } {
              $databricksHost = "${{ vars.UAT_DATABRICKS_HOST }}"
              $clientId = "${{ vars.UAT_DATABRICKS_CLIENT_ID }}"
              $clientSecret = "${{ secrets.UAT_DATABRICKS_CLIENT_SECRET }}"
            }
            'PROD' {
              $databricksHost = "${{ vars.PROD_DATABRICKS_HOST }}"
              $clientId = "${{ vars.PROD_DATABRICKS_CLIENT_ID }}"
              $clientSecret = "${{ secrets.PROD_DATABRICKS_CLIENT_SECRET }}"
            }
          }

          # Validate required credentials
          if (-not $databricksHost) {
            Write-Error "‚ùå DATABRICKS_HOST is not set for $env:TARGET_ENV environment"
            Write-Error "   Required variable: $($env:TARGET_ENV)_DATABRICKS_HOST"
            exit 1
          }
          if (-not $clientId) {
            Write-Error "‚ùå CLIENT_ID is not set for $env:TARGET_ENV environment"
            Write-Error "   Required variable: $($env:TARGET_ENV)_DATABRICKS_CLIENT_ID"
            exit 1
          }
          if (-not $clientSecret) {
            Write-Error "‚ùå CLIENT_SECRET is not set for $env:TARGET_ENV environment"
            Write-Error "   Required secret: $($env:TARGET_ENV)_DATABRICKS_CLIENT_SECRET"
            exit 1
          }

          Write-Host "‚úÖ Credentials validated for $env:TARGET_ENV"
          Write-Host "   - Host: $databricksHost"
          Write-Host "   - Client ID: $($clientId.Substring(0, [Math]::Min(8, $clientId.Length)))..."

          # Create .databrickscfg in user profile root (not in .databricks subdirectory)
          $configPath = "$env:USERPROFILE\.databrickscfg"

          # Write config file with Service Principal authentication ONLY
          "[$($env:TARGET_ENV)]" | Out-File -FilePath $configPath -Encoding utf8 -Force
          "host = $databricksHost" | Out-File -FilePath $configPath -Encoding utf8 -Append
          "client_id = $clientId" | Out-File -FilePath $configPath -Encoding utf8 -Append
          "client_secret = $clientSecret" | Out-File -FilePath $configPath -Encoding utf8 -Append

          # Secure the config file
          icacls $configPath /inheritance:r /grant:r "$env:USERNAME`:F" | Out-Null

          Write-Host "‚úÖ Config file created at: $configPath"
          Write-Host ""
          Write-Host "üìÑ Config file contents (redacted):"
          Write-Host "[$($env:TARGET_ENV)]"
          Write-Host "host = $databricksHost"
          Write-Host "client_id = $($clientId.Substring(0, [Math]::Min(8, $clientId.Length)))***"
          Write-Host "client_secret = ***"

          # Test authentication
          Write-Host ""
          Write-Host "üß™ Testing authentication..."
          try {
            $authTest = databricks auth profiles 2>&1
            if ($LASTEXITCODE -ne 0) {
              Write-Error "‚ùå Authentication test failed with exit code: $LASTEXITCODE"
              Write-Host "Output: $authTest"
              exit 1
            }
            Write-Host "‚úÖ Authentication successful!"
            Write-Host "Available profiles: $authTest"
          }
          catch {
            Write-Error "‚ùå Authentication test failed: $_"
            exit 1
          }

      # Step 8: Validate Databricks Bundle
      - name: Validate Databricks Bundle
        shell: pwsh
        env:
          TARGET_ENV: ${{ steps.determine-env.outputs.environment }}
          DATABRICKS_CONFIG_PROFILE: ${{ steps.determine-env.outputs.environment }}
        run: |
          Write-Host "üîç Validating Databricks bundle for $env:TARGET_ENV environment..."

          cd AMALDAB

          Write-Host "üìÇ Current directory: $(Get-Location)"
          Write-Host "üìÑ Files in bundle directory:"
          Get-ChildItem | Format-Table Name, Length, LastWriteTime

          # Validate bundle
          try {
            Write-Host ""
            Write-Host "üîç Running: databricks bundle validate -t $env:TARGET_ENV"
            databricks bundle validate -t $env:TARGET_ENV

            if ($LASTEXITCODE -ne 0) {
              Write-Error "‚ùå Bundle validation failed with exit code: $LASTEXITCODE"
              exit $LASTEXITCODE
            }

            Write-Host "‚úÖ Bundle validation successful!"
          }
          catch {
            Write-Error "‚ùå Bundle validation failed: $_"
            exit 1
          }

      # Step 9: Deploy Databricks Bundle
      - name: Deploy Databricks Bundle
        shell: pwsh
        env:
          TARGET_ENV: ${{ steps.determine-env.outputs.environment }}
          DATABRICKS_CONFIG_PROFILE: ${{ steps.determine-env.outputs.environment }}
        run: |
          Write-Host "üöÄ Deploying Databricks bundle to $env:TARGET_ENV environment..."

          cd AMALDAB

          # Deploy bundle
          try {
            Write-Host ""
            Write-Host "üöÄ Running: databricks bundle deploy -t $env:TARGET_ENV"
            databricks bundle deploy -t $env:TARGET_ENV

            if ($LASTEXITCODE -ne 0) {
              Write-Error "‚ùå Bundle deployment failed with exit code: $LASTEXITCODE"
              exit $LASTEXITCODE
            }

            Write-Host ""
            Write-Host "‚úÖ Deployment completed successfully!"
          }
          catch {
            Write-Error "‚ùå Bundle deployment failed: $_"
            exit 1
          }

      # Step 10: Sync workspace and remove deleted files
      - name: Sync workspace with deletion
        shell: pwsh
        env:
          TARGET_ENV: ${{ steps.determine-env.outputs.environment }}
          DATABRICKS_CONFIG_PROFILE: ${{ steps.determine-env.outputs.environment }}
        run: |
          Write-Host "üîÑ Syncing workspace and removing deleted files..."
          Write-Host "üéØ Target Environment: $env:TARGET_ENV"

          # Set execution policy
          Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope Process -Force

          # Determine workspace path based on environment
          $workspacePath = switch ($env:TARGET_ENV) {
            'DEV' { "/Workspace/AMAL_DEV/DEV" }
            { $_ -in 'uat', 'UAT' } { "/Workspace/uat" }
            'PROD' { "/Workspace/PROD" }
            default { "/Workspace/$env:TARGET_ENV" }
          }

          Write-Host "üìÇ Workspace Path: $workspacePath"

          # Check if sync script exists
          $scriptPath = ".github/workflows/sync-with-deletion.ps1"
          if (-not (Test-Path $scriptPath)) {
            Write-Warning "‚ö†Ô∏è  Sync script not found at: $scriptPath - skipping sync"
            Write-Host "‚úÖ Deployment completed (sync skipped)"
            exit 0
          }

          Unblock-File -Path $scriptPath -ErrorAction SilentlyContinue

          # Run sync script
          try {
            & $scriptPath -Environment $env:TARGET_ENV -SourceDir "AMALDAB/DataPlatform" -WorkspacePath $workspacePath

            if ($LASTEXITCODE -and $LASTEXITCODE -ne 0) {
              Write-Error "‚ùå Sync with deletion failed with exit code: $LASTEXITCODE"
              exit $LASTEXITCODE
            }

            Write-Host "‚úÖ Workspace sync completed successfully"
          }
          catch {
            Write-Error "‚ùå Sync with deletion failed: $_"
            exit 1
          }

          Write-Host ""
          Write-Host "=" * 70
          Write-Host "üéâ DEPLOYMENT COMPLETED SUCCESSFULLY!"
          Write-Host "=" * 70
          Write-Host "‚úÖ Environment: $env:TARGET_ENV"
          Write-Host "‚úÖ Configuration updated"
          Write-Host "‚úÖ Bundle validated"
          Write-Host "‚úÖ Bundle deployed"
          Write-Host "‚úÖ Workspace synced"
          Write-Host "=" * 70
