name: Databricks Notebooks Deployment

on:
  workflow_dispatch:
  # push:
  #   branches: [main, dev, qa]
  #   paths:
  #     - 'AMALDAB/**'
  #     - '.github/workflows/**'

jobs:
  run-prerequisites:
    runs-on: windows-latest
    outputs:
      env_name: ${{ steps.set-env.outputs.env_name }}
    steps:
      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.8'

      - name: Install Python dependencies
        shell: pwsh
        run: |
          python -m pip install --upgrade pip
          pip install requests databricks-cli PyYAML

      - name: Install Databricks CLI
        uses: databricks/setup-cli@v0.3.0
        with:
          version: '0.230.0'

      - name: Create AMALDAB directory structure
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path "AMALDAB/resources/SharedObjects"
          Write-Host "✅ Directory structure created"

      - name: Determine environment
        id: set-env
        shell: pwsh
        run: |
          $branch = "${{ github.ref }}"
          $envName = switch ($branch) {
            "refs/heads/main" { "PROD" }
            "refs/heads/qa"   { "QA" }
            "refs/heads/dev"  { "DEV" }
            default           { "DEV" }
          }
          echo "ENV_NAME=$envName" | Out-File -FilePath $env:GITHUB_ENV -Append
          echo "env_name=$envName" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          Write-Host "::notice::Target environment: $envName"

      - name: Generate Databricks config file
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path $env:USERPROFILE\.databricks
          @"
          [DEV]
          host = "${{ vars.QA_DATABRICKS_HOST }}"
          client_id = "${{ vars.DEV_DATABRICKS_CLIENT_ID }}"
          client_secret = "${{ secrets.DEV_DATABRICKS_CLIENT_SECRET }}"
          
          [QA]
          host = "${{ vars.QA_DATABRICKS_HOST }}"
          client_id = "${{ vars.QA_DATABRICKS_CLIENT_ID }}"
          client_secret = "${{ secrets.QA_DATABRICKS_CLIENT_SECRET }}"
          
          [PROD]
          host = "${{ vars.PROD_DATABRICKS_HOST }}"
          client_id = "${{ vars.PROD_DATABRICKS_CLIENT_ID }}"
          client_secret = "${{ secrets.PROD_DATABRICKS_CLIENT_SECRET }}"
          
          "@ | Out-File -FilePath "$env:USERPROFILE\.databrickscfg" -Encoding utf8
          icacls "$env:USERPROFILE\.databrickscfg" /inheritance:r /grant:r "$env:USERNAME:F"
          databricks auth profiles
          Write-Host "✅ .databrickscfg generated with UAT and PROD profiles"

      - name: Run prerequisites Python script
        shell: pwsh
        env:
          ENV_NAME: ${{ env.ENV_NAME }}
          DATABRICKS_CONFIG_PROFILE: ${{ env.ENV_NAME }}
        run: |
          Write-Host "Running prerequisites.py for $env:ENV_NAME..."

          # Resolve host based on ENV_NAME
          $databricksHost = if ($env:ENV_NAME -eq "PROD") { 
            "${{ vars.PROD_DATABRICKS_HOST }}" 
          } else { 
            "${{ vars.UAT_DATABRICKS_HOST }}" 
          }  
          
          $databricksToken = "${{ secrets.DATABRICKS_TOKEN }}"
          
          # Run script with CLI args
          python .github/workflows/prerequisites.py `
            --DATABRICKS_HOST "$databricksHost" `
            --DATABRICKS_TOKEN "$databricksToken"

          # Verify outputs
          $files = @(
            "AMALDAB/resources/SharedObjects/all_purpose_clusters.yml",
            "AMALDAB/resources/SharedObjects/sql_warehouses.yml"
          )
          foreach ($f in $files) {
            if (Test-Path $f) {
              Write-Host "✅ $f generated"
            } else {
              Write-Host "::error::$f missing!"
              exit 1
            }
          }

      - name: Commit generated files (if changed)
        shell: pwsh
        run: |
          git add AMALDAB/resources/
          $gitStatus = git status --porcelain
          if ($gitStatus) {
            git commit -m "chore(deploy): auto-generate configs for ${{ env.ENV_NAME }}"
            git push
            Write-Host "✅ Pushed generated configs"
          } else {
            Write-Host "➡️ No changes to commit"
          }

  deploy-notebooks:
    runs-on: windows-latest
    needs: run-prerequisites
    env:
      ENV_NAME: ${{ needs.run-prerequisites.outputs.env_name }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Databricks CLI
        uses: databricks/setup-cli@v0.3.0
        with:
          version: '0.230.0'

      - name: Generate Databricks config for deployment
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path $env:USERPROFILE\.databricks
          @"
          [DEV]
          host = "${{ vars.QA_DATABRICKS_HOST }}"
          client_id = "${{ vars.DEV_DATABRICKS_CLIENT_ID }}"
          client_secret = "${{ secrets.DEV_DATABRICKS_CLIENT_SECRET }}"
          
          [UAT]
          host = "${{ vars.QA_DATABRICKS_HOST }}"
          client_id = "${{ vars.QA_DATABRICKS_CLIENT_ID }}"
          client_secret = "${{ secrets.QA_DATABRICKS_CLIENT_SECRET }}"
          
          [PROD]
          host = "${{ vars.PROD_DATABRICKS_HOST }}"
          client_id = "${{ vars.PROD_DATABRICKS_CLIENT_ID }}"
          client_secret = "${{ secrets.PROD_DATABRICKS_CLIENT_SECRET }}"
          
          "@ | Out-File -FilePath "$env:USERPROFILE\.databrickscfg" -Encoding utf8
          icacls "$env:USERPROFILE\.databrickscfg" /inheritance:r /grant:r "$env:USERNAME:F"
          databricks auth profiles
          Write-Host "✅ .databrickscfg generated for deployment"

      - name: Deploy Databricks bundle
        shell: pwsh
        env:
          DATABRICKS_CONFIG_PROFILE: ${{ needs.run-prerequisites.outputs.env_name }}
        run: |
          cd AMALDAB
          Write-Host "Deploying to target: $env:DATABRICKS_CONFIG_PROFILE"

          # Test auth
          databricks auth profiles
          databricks clusters list --output JSON | ConvertFrom-Json | Select-Object -First 1
          Write-Host "✅ Auth successful"

          # Install & deploy
          databricks bundle install
          databricks bundle deploy

          Write-Host "✅ Deployment completed for $env:DATABRICKS_CONFIG_PROFILE"
