name: Databricks Notebooks Deployment

on:
  workflow_dispatch:
    inputs:
      target_env:
        description: 'Override target environment (e.g., dev, qa, prod)'
        required: false
        default: ''
        type: choice
        options:
          - ''
          - dev
          - qa
          - prod
  push:
    branches:
      - main
      - dev
      - qa
    paths:
      - amalDatabricks_Demo_01/**
      - AMALDAB/**
      - resources/**
      - config/**
      - metrics/data_platform/**
      - .github/workflows/**
      - databricks.yml

env:
  # Map branch → Databricks profile & bundle target
  # Extend this as needed
  BRANCH_TO_PROFILE: |
    main:PROD:prod
    dev:QA:dev
    qa:QA:qa
    feature:QA:dev
    hotfix:QA:qa

jobs:
  resolve-env:
    runs-on: windows-latest
    outputs:
      databricks_profile: ${{ steps.resolve.outputs.profile }}
      bundle_target: ${{ steps.resolve.outputs.target }}
      workspace_host: ${{ steps.resolve.outputs.host }}
    steps:
      - name: Resolve environment from branch or input
        id: resolve
        shell: bash
        run: |
          BRANCH="${{ github.ref_name }}"
          INPUT_ENV="${{ github.event.inputs.target_env }}"

          echo "Detected branch: $BRANCH"
          echo "Manual input env: $INPUT_ENV"

          # Prefer manual input
          if [ -n "$INPUT_ENV" ]; then
            case "$INPUT_ENV" in
              dev)   PROFILE="QA"; TARGET="dev"; HOST="${{ vars.QA_DATABRICKS_HOST }}" ;;
              qa)    PROFILE="QA"; TARGET="qa";  HOST="${{ vars.QA_DATABRICKS_HOST }}" ;;
              prod)  PROFILE="PROD"; TARGET="prod"; HOST="${{ vars.PROD_DATABRICKS_HOST }}" ;;
              *)     echo "⚠️ Unknown input env: $INPUT_ENV"; exit 1 ;;
            esac
          else
            # Map branch → profile:target
            while IFS=':' read -r branch profile target; do
              if [[ "$BRANCH" == $branch* ]]; then
                PROFILE="$profile"
                TARGET="$target"
                break
              fi
            done <<< "${{ env.BRANCH_TO_PROFILE }}"

            # Set host based on profile
            if [ "$PROFILE" = "PROD" ]; then
              HOST="${{ vars.PROD_DATABRICKS_HOST }}"
            else
              HOST="${{ vars.QA_DATABRICKS_HOST }}"
            fi
          fi

          if [ -z "$PROFILE" ] || [ -z "$TARGET" ] || [ -z "$HOST" ]; then
            echo "❌ Failed to resolve env for branch: $BRANCH"
            exit 1
          fi

          echo "Resolved: profile=$PROFILE, target=$TARGET, host=$HOST"
          echo "profile=$PROFILE" >> $GITHUB_OUTPUT
          echo "target=$TARGET" >> $GITHUB_OUTPUT
          echo "host=$HOST" >> $GITHUB_OUTPUT

  run-prerequisites:
    runs-on: windows-latest
    needs: resolve-env
    outputs:
      status: ${{ steps.prerequisites.outcome }}
    steps:
      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GIT_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.8'

      - name: Install Python dependencies
        shell: pwsh
        run: |
          python -m pip install --upgrade pip
          pip install requests databricks-cli PyYAML

      - name: Create AMALDAB directory structure
        shell: pwsh
        run: |
          echo "Creating directory structure..."
          New-Item -ItemType Directory -Force -Path "AMALDAB/resources/SharedObjects"

      - name: Run prerequisites Python script
        id: prerequisites
        shell: pwsh
        env:
          DATABRICKS_HOST: ${{ needs.resolve-env.outputs.host }}
          DATABRICKS_TOKEN: ${{ secrets.DATABRICKS_TOKEN }}
          DATABRICKS_CLIENT_ID: ${{ vars.DATABRICKS_CLIENT_ID }}
          DATABRICKS_CLIENT_SECRET: ${{ secrets.DATABRICKS_CLIENT_SECRET }}
        run: |
          echo "Running prerequisites for env: $env:DATABRICKS_HOST"
          # python .github/workflows/prerequisites.py
          echo "✅ Prerequisites completed (mocked)"

      - name: Commit generated files to Git
        shell: pwsh
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add AMALDAB/resources/
          if (-not (git diff --cached --quiet)) {
            git commit -m "chore: auto-generate configs for ${{ needs.resolve-env.outputs.target }}"
            git push
            echo "✅ Changes committed"
          } else {
            echo "➡️ No changes to commit"
          }

  deploy-notebooks:
    runs-on: windows-latest
    needs: [resolve-env, run-prerequisites]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Databricks CLI
        shell: pwsh
        run: |
          Set-ExecutionPolicy Bypass -Scope Process -Force
          [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072
          iex ((New-Object System.Net.WebClient).DownloadString('https://community.chocolatey.org/install.ps1'))
          choco install databricks-cli -y

      - name: Authenticate Databricks Workspace
        shell: pwsh
        run: |
          $cfg = "$env:USERPROFILE\.databrickscfg"
          New-Item -ItemType Directory -Force -Path "$env:USERPROFILE\.databricks"

          # Write config with both profiles
          @"
          [PROD]
          host = ${{ vars.PROD_DATABRICKS_HOST }}
          client_id = ${{ vars.DATABRICKS_CLIENT_ID }}
          client_secret = ${{ secrets.DATABRICKS_CLIENT_SECRET }}

          [QA]
          host = ${{ vars.QA_DATABRICKS_HOST }}
          client_id = ${{ vars.DATABRICKS_CLIENT_ID }}
          client_secret = ${{ secrets.DATABRICKS_CLIENT_SECRET }}
          "@ | Out-File -FilePath $cfg -Encoding utf8

          icacls $cfg /inheritance:r /grant:r "$env:USERNAME:F"
          Write-Host "✅ Databricks config written for ${{ needs.resolve-env.outputs.databricks_profile }}"

      - name: Deploy Databricks bundle
        shell: pwsh
        env:
          DATABRICKS_CONFIG_PROFILE: ${{ needs.resolve-env.outputs.databricks_profile }}
        run: |
          cd AMALDAB
          echo "Deploying to target: ${{ needs.resolve-env.outputs.bundle_target }} (profile: $env:DATABRICKS_CONFIG_PROFILE)"
          databricks bundle deploy --target ${{ needs.resolve-env.outputs.bundle_target }}

  validate-deployment:
    runs-on: windows-latest
    needs: deploy-notebooks
    steps:
      - run: echo "✅ Deployment to ${{ needs.resolve-env.outputs.bundle_target }} succeeded!"
