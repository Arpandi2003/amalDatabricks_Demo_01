resources:
  jobs:
    WF_Incremental_Load:
      name: fact_campaign_daily
      permissions: 
        - group_name: DataEngineering
          level: CAN_MANAGE
        - group_name: DataEngineering-Contractors
          level: CAN_MANAGE
      parameters:
        - name: catalog_name 
          default: ${var.catalog_name}
      webhook_notifications:
        on_failure:
          - id: ${var.notification_channel}
      trigger:
        pause_status: UNPAUSED
        periodic:
          interval: 1
          unit: HOURS
      tasks:
        - task_key: Dim_Traffic_Source_Load
          notebook_task:
            notebook_path: ../metrics/data_platform/Gold/NB_Dim_Traffic_Source.py
            base_parameters:
              minion_catalog_name: ${var.minion_catalog_name}
            source: WORKSPACE
          job_cluster_key: Metric_Job_Cluster
        - task_key: Fact_Profile_Request_Match_Load
          depends_on:
            - task_key: Dim_Traffic_Source_Load
          notebook_task:
            notebook_path: ../metrics/data_platform/Gold/NB_Fact_Profile_Request_Match.py
            source: WORKSPACE
          job_cluster_key: Metric_Job_Cluster
        - task_key: Fact_Campaign_Daily_Load
          depends_on:
            - task_key: Fact_Profile_Request_Match_Load
          notebook_task:
            notebook_path: ../metrics/data_platform/Gold/NB_Fact_campaign_daily.py
            source: WORKSPACE
          job_cluster_key: Metric_Job_Cluster
        - task_key: Fact_Daily_Metrics_Load
          depends_on:
            - task_key: Fact_Campaign_Daily_Load
          notebook_task:
            notebook_path: ../metrics/data_platform/Gold/NB_Fact_daily_metrics.py
            source: WORKSPACE
          job_cluster_key: Metric_Job_Cluster
        - task_key: Business_Integrity_Check_Load
          depends_on:
            - task_key: Fact_Daily_Metrics_Load
          notebook_task:
            notebook_path: ../metrics/data_platform/General/NB_Business_Rules_Validation.py
            source: WORKSPACE
          job_cluster_key: Metric_Job_Cluster
      job_clusters:
        - job_cluster_key: Metric_Job_Cluster
          new_cluster:
            cluster_name: ""
            spark_version: 17.1.x-scala2.13
            node_type_id: r7gd.4xlarge
            spark_env_vars:
              PYSPARK_PYTHON: /databricks/python3/bin/python3
            data_security_mode: DATA_SECURITY_MODE_STANDARD
            runtime_engine: STANDARD
            kind: CLASSIC_PREVIEW
            is_single_node: false
            autoscale:
              min_workers: 2
              max_workers: 8
      queue:
        enabled: true